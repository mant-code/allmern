#worker_processes 1;  # Set to the number of worker processes you need, typically 1 for basic setups.

#events {
    #worker_connections 1024;  # Adjust based on your system's needs (1024 is usually fine for basic setups).
#}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Upstream configuration for frontend
    upstream frontend {
        server frontend1:5173;  # Frontend1 inside Docker on port 5173
        server frontend2:5174;  # Frontend2 inside Docker on port 5174
    }

    # Upstream configuration for backend
    upstream backend {
        server backend1:5050;   # Backend1 inside Docker on port 5050
        server backend2:5051;   # Backend2 inside Docker on port 5051
    }

    # Main server block for handling HTTP requests
    server {
        listen 80;
        server_name localhost;

        # Handle requests to the frontend (load-balanced)
        location / {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        # Handle API routes (load-balanced)
        location /api/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Optional: Add timeouts for better control over backend responses
            proxy_read_timeout 90s;   # Adjust as necessary
            proxy_connect_timeout 90s; # Adjust as necessary
            proxy_send_timeout 90s;    # Adjust as necessary
        }
        
        # Optional: Add a health check endpoint for the backend
        location /api/health {
            access_log off;          # Disable logging for health checks
            return 200 'healthy';    # Simple response for health check
            add_header Content-Type text/plain; 
        }
    }
}
